name: 🏆 Update Rank

on:
  schedule:
    - cron: "40 11 * * 3" # Every Wednesday at 03:40 UTC
  workflow_dispatch:
    inputs:
      name:
        type: string
        description: Player name
        required: false
        default: "Liam Neville"
      format:
        type: choice
        description: Match Format
        options:
          - "SINGLES"
          - "DOUBLES"
        required: true
        default: "SINGLES"
      gender:
        type: choice
        description: Gender
        options:
          - "M"
          - "F"
        required: true
        default: "M"
      level:
        type: choice
        description: Level
        options:
          - "3.0"
          - "3.5"
          - "4.0"
          - "4.5"
          - "5.0"
        required: true
        default: "4.0"
      section:
        type: choice
        description: NTRP Section Code
        options:
          - "Eastern"
          - "Florida"
          - "Hawaii Pacific"
          - "Intermountain"
          - "Mid-Atlantic"
          - "Middle States"
          - "Midwest"
          - "Missouri Valley"
          - "New England"
          - "Northern California"
          - "Northern"
          - "Pacific NW"
          - "Southern"
          - "Southern California"
          - "Southwest"
          - "Texas"
          - "Unassigned"
        required: true
        default: "Northern California"

env:
  NAME: Liam Neville
  FORMAT: SINGLES
  GENDER: M
  LEVEL: "4.0"
  SECTION: Northern California

jobs:
  get_subscriber_details:
    runs-on: ubuntu-latest

    container: node:10.18-jessie

    services:
      redis:
        image: redis

        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    outputs:
      subscribers: ${{ steps.get_result.outputs.subscribers }}

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: 18

      - run: npm ci

      - name: Connect to Redis
        run: node client.js
        env:
          REDIS_HOST: ${{ secrets.REDIS_HOST }}
          REDIS_PORT: ${{ secrets.REDIS_PORT }}
          REDIS_USER: ${{ secrets.REDIS_USER }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}

      # - uses: actions/github-script@v6
      #   id: get-subscribers
      #   with:
      #     script: |
      #       const redis = require('redis')

      #       const client = createClient({ host: ${{ secrets.REDIS_HOST }}, user: ${{ secrets.REDIS_USER }}, password: ${{ secrets.REDIS_PASSWORD }} })

      #       await client.connect()

      #       console.log('Redis connected')

      #       const keys = await client.sendCommand(["keys","*"])

      #       console.log(keys)

      #       await client.disconnect()

      #       return keys
      #     result-encoding: json

      - name: Get result
        id: get_result
        run: |
          echo "subscribers=$(
            echo '${{ steps.get-subscribers.outputs.result }}'
          )" >> $GITHUB_OUTPUT

  run_and_send_emails:
    needs: get_subscriber_details
    runs-on: ubuntu-22.04

    strategy:
      matrix:
        subscribers: ${{ fromJson(needs.get_subscriber_details.outputs.subscribers) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - uses: satackey/action-docker-layer-caching@v0.0.11
        continue-on-error: true

      - name: Build
        working-directory: ${{ github.workspace }}
        run: docker build -t usta-cli .

      # - if: ${{ github.event_name == 'workflow_dispatch' }}
      #   name: Run Manual
      #   run: |
      #     echo 'EMAIL_BODY<<EOF' >> $GITHUB_ENV
      #     docker run usta-cli rankings get -n '${{ inputs.Name || env.NAME }}' -f '${{ inputs.Format || env.FORMAT }}' -g '${{ inputs.Gender || env.GENDER }}' -l '${{ inputs.Level || env.LEVEL }}' -s '${{ inputs.Section || env.SECTION }}' -o html >> $GITHUB_ENV
      #     echo 'EOF' >> $GITHUB_ENV

      # - if: ${{ github.event_name == 'schedule' }}
      - name: Run Scheduled
        run: |
          echo 'EMAIL_BODY<<EOF' >> $GITHUB_ENV
          docker run usta-cli rankings get -n '${{ matrix.subscribers.name }}' -f '${{ matrix.subscribers.format }}' -g '${{ matrix.subscribers.gender }}' -l '${{ matrix.subscribers.level }}' -s '${{ matrix.subscribers.section }}' -o html >> $GITHUB_ENV
          echo 'EOF' >> $GITHUB_ENV

      - name: Summary
        run: echo "$EMAIL_BODY" >> $GITHUB_STEP_SUMMARY

      - name: Send Email Notification
        uses: peter-evans/sendgrid-action@v1
        env:
          TO_EMAIL: ${{ matrix.subscribers.email }}
          FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
