name: Update Rank

on:
  schedule:
    - cron: "40 11 * * 3" # Every Wednesday at 03:40 UTC
  workflow_dispatch:
    inputs:
      name:
        type: string
        description: Player name
        required: false
        default: "Liam Neville"
      format:
        type: choice
        description: Match Format
        options:
          - "SINGLES"
          - "DOUBLES"
        required: true
        default: "SINGLES"
      gender:
        type: choice
        description: Gender
        options:
          - "M"
          - "F"
        required: true
        default: "M"
      level:
        type: choice
        description: Level
        options:
          - "level_3_0"
          - "level_3_5"
          - "level_4_0"
          - "level_4_5"
          - "level_5_0"
          - "level_5_5"
          - "level_6_0"
          - "level_6_5"
          - "level_7_0"
        required: true
        default: "level_4_0"
      section:
        type: choice
        description: NTRP Section Code
        options:
          - Eastern
          - Florida
          - Hawaii Pacific
          - Intermountain
          - Mid-Atlantic
          - Middle States
          - Midwest
          - Missouri Valley
          - New England
          - Northern California
          - Northern
          - Pacific NW
          - Southern
          - Southern California
          - Southwest
          - Texas
          - Unassigned
        required: true
        default: "Northern California"

env:
  NAME: Liam Neville
  FORMAT: SINGLES
  GENDER: M
  LEVEL: level_4_0
  SECTION: Northern California

jobs:
  update_rank:
    runs-on: ubuntu-22.04

    outputs:
      ranking_report: ${{ steps.run.outputs.ranking_report }}

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Build
        working-directory: ${{ github.workspace }}
        run: docker build -t usta-scraper .
      
      - uses: actions/github-script@v6
        id: set-output
        with:
          script: |
            core.setOutput("ranking_report", "$(docker run ghcr.io/lineville/usta-scraper -n "Liam Neville" -f SINGLES -g M -l level_4_0 -s "Northern California")")

  send_email:
    runs-on: ubuntu-22.04

    needs: update_rank

    steps:
      - name: Set Step Summary
        run: echo ${{ needs.update_rank.outputs.ranking_report }} >> $GITHUB_STEP_SUMMARY

      - name: Send Email Notification
        uses: peter-evans/sendgrid-action@v1
        env:
          TO_EMAIL: ${{ secrets.TO_EMAIL }}
          FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
          EMAIL_BODY: ${{ needs.update_rank.outputs.ranking_report }}
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
